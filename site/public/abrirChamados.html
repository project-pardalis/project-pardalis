<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Abrir Chamados | Pardalis</title>
    <link rel="stylesheet" href="css/abrirChamado.css">
</head>

<body>
    <header class="sticky-top bg-dark d-flex m-0 p-0 vw-auto shadow d-flex justify-content-between">
        <a class="navbar-brand px-2 fs-4 text-light" style="width: 15%;">Pardalis</a>

        <div class="navbar-nav w-auto">
            <div class="nav-item text-nowrap">
                <a class="nav-link px-3 text-light" onclick="sair()" style="cursor: pointer;">Sair</a>
            </div>
        </div>
    </header>


    <div class="container-fluid row m-0 p-0">
        <nav id="sidebarMenu" class="p-0 d-md-block bg-light collapse" style="width: 15%;">
            <div class="p-2 sidebar-sticky">
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <p class="h5 text-muted fw-bolder">Dashboards</p>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active h6 p-2 m-0 fw-bold" href='dashboard.html'
                            style="width: fit-content;">Home</a>
                    </li>
                    <ul class="nav flex-column mt-2">
                        <li class="nav-item">
                            <p class="h5 text-muted fw-bolder">Dashboard Temperatura</p>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link active h6 p-2 m-0" style="width: fit-content; " href="marco.html">
                                Ver dados temperatura</a>
                        </li>
                    </ul>
                    <ul class="nav flex-column mt-2">
                        <li class="nav-item">
                            <p class="h5 text-muted fw-bolder">Teste de Servidor</p>
                        </li>

                        </li>
                        <li class="nav-item">
                            <a class="nav-link active h6 p-2 m-0" style="width: fit-content;"
                                href="download-teste.html">Download &
                                Instruções</a>
                        </li>

                        <li class="nav-item">
                            <p class="h5 text-muted fw-bolder">Visão Macro</p>
                        </li>

                        <li class=" nav-item">
                            <a class="nav-link active h6 p-2 m-0" style="width: fit-content;"
                                href="performance.html">Ver
                                dados</a>
                        </li>


                    </ul>
                    <ul class="nav flex-column mt-2">
                        <li class="nav-item">
                            <p class="h5 text-muted fw-bolder">Histórico da máquina</p>
                        </li>

                        <li class="nav-item">
                            <a class="nav-link active h6 p-2 m-0" style="width: fit-content;" href="joao.html">Verificar
                                Histórico da máquina</a>
                        </li>
                    </ul>
                    <ul class="nav flex-column mt-2">
                        <li class="nav-item">
                            <p class="h5 text-muted fw-bolder">Chamado</p>
                        </li>

                        <li class="nav-item">

                        </li>
                        <li class="nav-item">
                            <a class="nav-link active h6 p-2 m-0" style="width: fit-content;"
                                href="chamadoIndex.html">Gerencia</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active h6 p-2 m-0" style="width: fit-content;"
                                href="abrirChamados.html">Abrir
                                chamados</a>
                        </li>
                    </ul>

                    <ul class="nav flex-column mt-2">
                        <li class="nav-item">
                            <p class="h5 text-muted fw-bolder">Conta</p>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active h6 p-2 m-0" style="width: fit-content;"
                                href="visualizar-contas.html">Gerenciar
                                Contas</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link active h6 p-2 m-0" style="width: fit-content;"
                                href="edit-account.html">Editar
                                Conta</a>
                        </li>
                    </ul>

            </div>
        </nav>

        <main class="main col-md-9 ms-sm-auto col-lg-10 px-md-4 text-center">
            <div class="content">

                <div class="cards">
                    <div class="cardInputs">
                        <div class="title">Abrir chamado</div>
                        <div class="inputs">
                            <label for="">E-mail</label>
                            <input onblur="runFetchEmailOnBlur()" type="email" id="emailUsuario">
                            <label for="">Categoria</label>
                            <select name="" id="categoriaUsuario">
                                <option value="Duvidas_e_informacoes">Dúvidas e informação</option>
                                <option value="Instabilidade_do_servidor">Instabilidade do servidor</option>
                                <option value="Incongruencia_dos_dados">Incongruência nos dados</option>
                                <option value="Pedido">Pedido</option>
                                <option value="Outros">Outros</option>
                            </select>
                            <label for="">Assunto</label>
                            <input type="text" id="assuntoUsuario">
                            <label for="">Máquina</label>
                            <select name="" onchange='mudarDadosPagina()' id="maquinaSelect">

                            </select>
                            <label for="">Descrição</label>
                            <textarea name="" id="descricaoUsuario" cols="30" rows="10"></textarea>
                            <button onclick="abrirChamado()">Enviar</button>
                        </div>

                    </div>
                    <div class="vertical-hr"></div>
                    <div class="cardDadosMaquina">
                        <div class="inputs">
                            <div class="title">Dados máquina</div>
                            <div class="dadosMaquina">

                                <p>
                                    Nome:
                                <div id="nomeMaquina"></div><br>
                                Hash: <div id="hashMaquina"></div><br>
                                Sistema operacional : <div id="soMaquina"></div>

                                </p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>
</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/js/bootstrap.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.5/dist/umd/popper.min.js"
    integrity="sha384-Xe+8cL9oJa6tN/veChSP7q+mnSPaj5Bcu9mPX5F5xIGE0DVittaqT5lorf0EI7Vk"
    crossorigin="anonymous"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.0/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-gH2yIJqKdNHPEq0n4Mqa/HGKIhSkIHeL5AyhkYV8i59U5AR6csBvApHHNl/vI1Bx" crossorigin="anonymous">
<script>

    maquinaSelect.style.display = 'block'
    dadosMaquina = 0


    function mudarDadosPagina() {
        res = getMachineInJson(dadosMaquina, maquinaSelect.value)
        nomeMaquina.innerHTML = res.nomeMaquina
        hashMaquina.innerHTML = res.hashMaquina
        soMaquina.innerHTML = res.sistemaOperacional
    }

    function getMachineInJson(arr, id) {
        for (i = 0; i < arr.length; i++) {

            if (arr[i].idMaquina == id) {

                return arr[i]
            }
        }
    }

    function validarChamado(email, categoria, assunto, descricao) {
        if (email == "" || categoria == "" || assunto == "" || descricao == "") {
            alert("Algum campo está vazio")
            console.log([
                email, categoria, assunto, descricao
            ])
            return false
        }

        else if (email.indexOf('@') == -1 || email.indexOf('.com') == -1) {
            alert("Email inválido")
            return false
        }
        else {
            return true
        }


    }



    function listarChamados() {
        //aguardar();

        //aguardar();
        fetch("rotas/listarChamado").then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {



                });
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });



    }
    function runFetchEmailOnBlur() {
        getDadosMaquina(emailUsuario.value)
    }


    function getChamadoJson(res) {
        for (i = 0; i < res.length; i++) {
            if (res[i].idChamado == sessionStorage.IDUSUARIO) {

                return res[i]
            }
            else {

            }
        }
    }



    boolPopSelect = false
    function popularSelect(res) {
        if (!boolPopSelect) {
            for (i = 0; i < res.length; i++) {
                maquinaSelect.innerHTML += `<option value="${res[i].idMaquina}">${res[i].nomeMaquina}</option>`
                maquinaSelect.style.display = 'block';
            }
        }
        boolPopSelect = true
    }
    function abrirChamado() {
        let email = document.getElementById('emailUsuario').value
        let categoria = document.getElementById('categoriaUsuario').value

        let assunto = document.getElementById('assuntoUsuario').value

        let descricao = document.getElementById('descricaoUsuario').value

        let fkMaquina = document.getElementById('maquinaSelect').value
        if (validarChamado(email, categoria, assunto, descricao)) {

            console.log([email, categoria, assunto, descricao])

            let res = fetch("rotas/adicionarChamado", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    emailChamado: email,
                    categoriaChamado: categoria,
                    assuntoChamado: assunto,
                    descricaoChamado: descricao,
                    categoriaChamado: categoria,
                    fkMaquina: fkMaquina


                })
            });
            console.log(res)
            console.log("Enviado! Indo para o Controller")
            alert("Chamado aberto! ")
            if (res.ok) {
                let resJson = res.json();

            }

        }


    }


    function getDadosMaquina(email) {
        fetch(`/rotas/getDadosMaquina?emailCliente=${email}`, {
            method: "GET",
            headers: {
                "Content-Type": "application/json"
            }

        }).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {

                    console.log(resposta)
                    dadosMaquina = resposta
                    popularSelect(resposta)


                });
            }
        })
    }



    listarChamados()

</script>