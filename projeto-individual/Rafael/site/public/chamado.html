<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <!-- Pegar id do chamado e criar essa webpage a partir disso. -->
    <div class="content">
        <div class="title-webpage-chamado" id="titlePage"> </div>
        <div class="descricao-webpage-chamado" id="descricaoPage"></div>
        <div class="cliente-webpage-chamado" id="clientePage"></div>
        <div id="emailPage"></div>
        <div id="nomePage"></div>
        <div id="categoriaPage"></div>
        <div id="dataPage"> </div>
        <button onclick="fecharChamado()">Fechar chamado</button>
        <button>Abrir relatório</button>
        <div class="relatorio">

            <label for=""> Nome Máquina:</label>
            <div id="nomeMaquina"></div>
            <label for="">Hash máquina:</label>
            <div id="hashMaquina"></div>


            <div class="dadosMaquina">

            </div>
        </div>



    </div>
</body>

<script>


    let dadosChamado = 0
    function getDataLeitura(res) {

        data = new Date(dadosChamado[0].dataChamado)
        data = data - 1000 * 60 * 60 * 3
        data = String(new Date(data).toISOString())

        console.log(data)


        fetch("/getLeituraMetricaDados/?idMaquina=" + res[0].idMaquina + "&dataChamado=" + data).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    console.log('work')
                    console.log(resposta)

                });
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });

    }


    function listarChamados() {
        //aguardar();
        fetch("/listarChamado/?id=" + sessionStorage.IDUSUARIO).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {

                    dadosChamado = resposta
                    plotarPagina(resposta)
                    getDadosMaquina(resposta)


                });
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });



    }
    function getDadosMaquina(res) {
        console.log(res)
        fetch("/getDadosMaquina/?idMaquina=" + res[0].fkMaquina).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {


                    getDataLeitura(resposta)
                });
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });



    }
    function fecharChamado() {
        let res = fetch("/fecharChamado", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idChamado: sessionStorage.IDUSUARIO
            })
        });

        console.log("Enviado! Indo para o Controller")

        if (res != undefined) {

            alert("Chamado fechado!")
            window.location.href = './index.html'
        }
    }




    function plotarPagina(arr) {

        userEmail = getUserEmail(arr)

        console.log("email: " + userEmail)
        res = getArrayJsonId(arr)
        data = new Date(String(res.dataChamado)).toLocaleDateString()

        titlePage.innerHTML = res.assuntoChamado;
        categoriaPage.innerHTML = res.categoriaChamado;
        nomePage.innerHTML = res.nomeUsuario;
        emailPage.innerHTML = userEmail
        dataPage.innerHTML = data;
        descricaoPage.innerHTML = res.descricaoChamado;
        // nomeMaquina.innerHTML = res.nomeMaquina
        // hashMaquina.innerHTML = res.hashMaquina

    }

    function getUserEmail(res) {
        for (i = 0; i < res.length; i++) {
            if (res[i].idChamado == sessionStorage.IDUSUARIO) {
                return res[i].emailUsuario;
            }
        }
    }
    function getArrayJsonId(arr) {
        bool = false;
        for (i = 0; i < arr.length; i++) {
            if (arr[i].idChamado == parseInt(sessionStorage.IDUSUARIO)) {
                bool = true;
                return arr[i]
            }
        }
        if (bool = false) return alert("Ocorreu um erro")
    }
    listarChamados()
</script>

</html>