<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <title>Document</title>
</head>

<body>
    <!-- Pegar id do chamado e criar essa webpage a partir disso. -->
    <div class="content">
        <div class="title-webpage-chamado" id="titlePage"> </div>
        <div class="descricao-webpage-chamado" id="descricaoPage"></div>
        <div class="cliente-webpage-chamado" id="clientePage"></div>
        <div id="emailPage"></div>
        <div id="nomePage"></div>
        <div id="categoriaPage"></div>
        <div id="dataPage"> </div>
        <button onclick="fecharChamado()">Fechar chamado</button>
        <button>Abrir relatório</button>

        <div class="respostaChamado">
            <label for="resposta-chamado">Resposta chamado chamado</label>
            <textarea name="" id="ipt_resposta_chamado" cols="30" rows="10"></textarea>
        </div>
        <button onclick="responderChamado()">Responder chamado</button>
        <div class="relatorio">

            <div class="graficos">
                <div class="chart" id="chartLine">
                    <canvas id="lineChartCompUse">

                    </canvas>
                </div>
                <div class="chart" id="chartGeneral">
                    <canvas id="generalChartUsePercent">

                    </canvas>
                </div>
            </div>


            <!-- Graficos:
            - maior uso por cada componente
            - uso do componente que ele escolheu (linha)
            - temperatura da cpu
            -kpis sinalizando media
            -analise automatica se "alerta! ", "crítico" ou "tudo normal" -->
            <label for=""> Nome Máquina:</label>
            <div id="nomeMaquina"></div>
            <label for="">Hash máquina:</label>
            <div id="hashMaquina"></div>

            Ver componentes:
            <select name="" onchange='getDataLeitura(dadosMaquina)' id="selectComponente">
                <option value="cpu">CPU</option>
                <option value="ram">RAM</option>
                <option value="disco">DISCO</option>
            </select>

            <div class="dadosMaquina">
                <p>
                    Média de uso do
                <div class="componente"></div> : <div id="mediaUso"></div>
                </p>
                <p>
                    Pico de uso
                <div class="componente"></div> : <div id="maxUso"></div>
                <div class="chart" id="chartUso">

                </div>
                </p>
                <p>A situação do
                <div class="componente"></div> é :
                <div id="alertasUso"></div>
                </p>

                <div class="chart" id="chartMax">

                </div>
            </div>
        </div>



    </div>
</body>

<script>


    let dadosChamado = 0
    let dadosMaquina = 0
    let dadosLeitura = 0

    function getMedia(res) {
        med = 0
        for (i = 0; i < res.length; i++) {
            med += parseFloat(res[i].valorLeitura)
        }
        return Math.round(med / res.length, 2)
    }
    function getAlertas(res, comp) {
        alerts = { 'risco': 0, 'alerta': 0, 'ok': 0 }
        for (i = 0; i < res.length; i++) {
            if (comp == 'cpu') {
                if (res[i].valorLeitura > 90) {
                    alerts.risco += 1;
                }
                else if (res[i].valorLeitura < 60 && res[i].valorLeitura >= 0) {
                    alerts.ok += 1;
                }
                else {
                    alerts.alerta += 1;
                }
            }
            else if (comp == 'ram') {
                if (res[i].valorLeitura > 7.80) {
                    alerts.risco += 1;
                }
                else if (res[i].valorLeitura < 6 && res[i].valorLeitura >= 0) {
                    alerts.ok += 1;
                }
                else {
                    alerts.alerta += 1;
                }
            }
            else if (comp == 'disco') {
                if (res[i].valorLeitura > 70) {
                    alerts.risco += 1;
                }
                else if (res[i].valorLeitura < 50 && res[i].valorLeitura >= 0) {
                    alerts.ok += 1;
                }
                else {
                    alerts.alerta += 1;
                }
            }
        }
        console.log(alerts)
        return alerts
    }
    function getMaiorUso(res, comp) {
        max = 0
        for (i = 0; i < res.length; i++) {
            if (parseFloat(res[i].valorLeitura) > max) {
                max = parseFloat(res[i].valorLeitura)
            }
        }
        return max
    }
    function plotOnScreen(plot, value, comp) {
        txt = ''
        if (comp == 'ram') {
            txt = 'GB'
        }
        else if (comp == 'cpu' || comp == 'disco') {
            txt = '%'
        }
        plot.innerHTML = value + txt
    }
    function createCanvas(element, name) {
        console.log(element)
        if (element.lastChild != undefined) {
            element.lastChild.remove()
        }
        element.innerHTML = `<canvas id='${name}'> </canvas>`
        console.log(element)
    }

    function alterarPrioridadeNecessario(alertas, id) {
        risco = "Normal"
        if (alertas.risco > 20) {
            risco = 'Urgente'
        }
        else if (alertas.alerta > 40) {
            risco = "Alerta"
        }


        fetch("/updatePrioridade/?idChamado=" + id + "&riscoChamado=" + risco).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    console.log(resposta)
                    dadosLeitura = resposta
                    plotarAnalytics(dadosLeitura)


                });
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });

    }
    function plotarAnalytics(res) {
        let media = getMedia(res)
        let alertas = getAlertas(res, selectComponente.value)
        let maiorUso = getMaiorUso(res)
        let valores = []
        let label = []



        elements = document.getElementsByClassName('componente')


        console.log(res)
        for (i = 0; i < elements.length; i++) {
            elements[i].innerHTML = selectComponente.value
        }

        for (i = 0; i < res.length; i++) {
            valores.push(parseInt(res[i].valorLeitura))
            if (i % 5 == 0) {
                label.push(i)
            }
        }

        createCanvas(document.getElementById('chartMax'), 'metricasUsoComp' + selectComponente.value)
        createCanvas(document.getElementById('chartUso'), 'maxUsoComp' + selectComponente.value)
        createCanvas(document.getElementById('chartLine'), 'lineChartCompUse' + selectComponente.value)
        //charts config     

        plotarGraficoPorChamadoDados(valores, label, selectComponente.value)
        maxUsoComp([maiorUso], [selectComponente.value + "Uso", 'Uso disponível'], selectComponente.value)


        //data
        console.log(selectComponente.value + " DA TELA HTML COMPONENTE")
        plotOnScreen(document.getElementById('mediaUso'), media, selectComponente.value)
        plotOnScreen(document.getElementById('maxUso'), maiorUso, selectComponente.value)
        plotOnScreen(document.getElementById('lineChartCompUse' + selectComponente.value), label, selectComponente.value)

        alertasUso.innerHTML = `<div class='situacaoAlertas'> <div class='alertaTexto'> Ok: ${alertas.ok}x </div> 
        <div class='alertaTexto'> Alerta: ${alertas.alerta}x </div>
        <div class='alertaTexto'> Risco: ${alertas.risco}x </div></div>  `
        chartmetricasUsoComp([parseInt(alertas.ok), parseInt(alertas.alerta), parseInt(alertas.risco)], ['Ok!', 'Cuidado!!', '!!Risco!!'], selectComponente.value)


        alterarPrioridadeNecessario(alertas, sessionStorage.IDUSUARIO)



    }


    function getDataLeitura(res) {

        let data = new Date(dadosChamado[0].dataChamado)
        data = data
        data = String(new Date(data).toISOString())


        let metrica = ''
        if (selectComponente.value == 'cpu') {
            metrica = 'cpu_Utilizacao'
        }
        else if (selectComponente.value == 'ram') {
            metrica = 'ram_Usada'
        }
        else {
            metrica = 'disco_Usado'
        }
        console.log(data)
        fetch("/getLeituraMetricaDados/?idMaquina=" + res[0].idMaquina + "&dataChamado=" + data + "&metrica=" + metrica).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    console.log(resposta)
                    dadosLeitura = resposta
                    plotarAnalytics(dadosLeitura)


                });
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });


    }


    function listarChamados() {
        //aguardar();
        fetch("/listarChamado/?id=" + sessionStorage.IDUSUARIO).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {

                    dadosChamado = resposta
                    plotarPagina(resposta)
                    getDadosMaquina(resposta)


                });
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });



    }
    function getDadosMaquina(res) {
        console.log(res)
        fetch("/getDadosMaquina/?idMaquina=" + res[0].fkMaquina).then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {

                    dadosMaquina = resposta

                });
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });



    }
    function fecharChamado() {
        let res = fetch("/fecharChamado", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idChamado: sessionStorage.IDUSUARIO
            })
        });

        console.log("Enviado! Indo para o Controller")

        if (res != undefined) {

            alert("Chamado fechado!")
            window.location.href = './index.html'
        }
    }




    function plotarPagina(arr) {

        userEmail = getUserEmail(arr)

        console.log("email: " + userEmail)
        res = getArrayJsonId(arr)
        data = new Date(String(res.dataChamado)).toLocaleDateString()

        titlePage.innerHTML = res.assuntoChamado;
        categoriaPage.innerHTML = res.categoriaChamado;
        nomePage.innerHTML = res.nomeUsuario;
        emailPage.innerHTML = userEmail
        dataPage.innerHTML = data;
        descricaoPage.innerHTML = res.descricaoChamado;
        nomeMaquina.innerHTML = res.nomeMaquina
        hashMaquina.innerHTML = res.hashMaquina

    }

    function getUserEmail(res) {
        for (i = 0; i < res.length; i++) {
            if (res[i].idChamado == sessionStorage.IDUSUARIO) {
                return res[i].emailUsuario;
            }
        }
    }
    function getArrayJsonId(arr) {
        bool = false;
        for (i = 0; i < arr.length; i++) {
            if (arr[i].idChamado == parseInt(sessionStorage.IDUSUARIO)) {
                bool = true;
                return arr[i]
            }
        }
        if (bool = false) return alert("Ocorreu um erro")
    }

    function responderChamado() {

        let idChamado = dadosChamado[0].idChamado
        let respostaChamado = ipt_resposta_chamado.value
        console.log('teste')
        fetch("/responderChamado", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                idServer: idChamado,
                respostaChamado: respostaChamado
            })
        });



        const url = 'https://hooks.slack.com/services/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';
        const res = axios.post(url, {
            channel: '#geral',
            text: `Olá! O seu chamado acaba de ser respondido!\n De: Analista de sistemas (pardalisprojeto@gmail.com)\n
               `
        }, { headers: { authorization: `Bearer ${slackToken}` } });

        console.log('Done', res.data);



    }
    listarChamados()
</script>
<script src="/js/chartsVisualizacaoChamados.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

</html>