<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
</head>

<body>
    <div class="title">Chamados</div>
    <div class="content">
        <div class="inputs">
            <label for="">E-mail</label>
            <input type="email" id="emailUsuario">
            <label for="">Categoria</label>
            <select name="" id="categoriaUsuario">
                <option value="Duvidas_e_informacoes">Dúvidas e informação</option>
                <option value="Instabilidade_do_servidor">Instabilidade do servidor</option>
                <option value="Incongruencia_dos_dados">Incongruência nos dados</option>
                <option value="Pedido">Pedido</option>
                <option value="Outros">Outros</option>
            </select>
            <label for="">Assunto</label>
            <input type="text" id="assuntoUsuario">
            <label for="">Descrição</label>
            <textarea name="" id="descricaoUsuario" cols="30" rows="10"></textarea>
            <label for="">Hash da máquina (Opcional) </label>
            <input type="text" id="hashUsuario">
            <button onclick="abrirChamado()">Enviar</button>
        </div>
    </div>


</body>

</html>
<script>
    whereUsuario = 0
    function validarChamado(email, categoria, assunto, descricao) {
        if (email == "" || categoria == "" || assunto == "" || descricao == "") {
            alert("Algum campo está vazio")
            console.log([
                email, categoria, assunto, descricao
            ])
            return false
        }

        else if (email.indexOf('@') == -1 || email.indexOf('.com') == -1) {
            alert("Email inválido")
            return false
        }
        else {
            return true
        }


    }



    function listarChamados() {
        //aguardar();

        //aguardar();
        fetch("/listarChamado").then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {

                    console.log(resposta)

                    whereUsuario = getIdCliente(resposta)

                });
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });



    }
    function getIdCliente(res) {
        for (i = 0; i < res.length; i++) {
            if (res[i].idChamado == parseInt(sessionStorage.IDUSUARIO)) {
                return res[i].idUsuario
            }

        }
    }
    function getChamadoJson(res) {
        for (i = 0; i < res.length; i++) {
            if (res[i].idChamado == sessionStorage.IDUSUARIO) {
                console.log(res[i])
                return res[i]
            }
            else {

            }
        }
    }


    function pegarMaquinasCliente() {
        fetch("/pegarMaquinasCliente").then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {

                    console.log(resposta)
                    body: JSON.stringify({
                        idUsuario: whereUsuario
                    })

                });
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });


    }
    function abrirChamado() {
        let email = document.getElementById('emailUsuario').value
        let categoria = document.getElementById('categoriaUsuario').value

        let assunto = document.getElementById('assuntoUsuario').value

        let descricao = document.getElementById('descricaoUsuario').value

        let hashUsuario = document.getElementById('hashUsuario').value

        if (validarChamado(email, categoria, assunto, descricao)) {

            console.log([email, categoria, assunto, descricao])

            let res = fetch("/adicionarChamado", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    emailChamado: email,
                    categoriaChamado: categoria,
                    assuntoChamado: assunto,
                    descricaoChamado: descricao,
                    categoriaChamado: categoria,
                    hashChamado: hashUsuario
                })
            });
            console.log(res)
            console.log("Enviado! Indo para o Controller")
            alert("Chamado aberto! ")
            if (res.ok) {
                let resJson = res.json();

            }

        }


    }
    listarChamados()
    pegarMaquinasCliente()
</script>