<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <title>Document</title>
</head>


<body>
    <div id="contentItem"></div>
    <div id="contentMenu">


        <div class="nav">
            <a href="abrirChamados.html">Abrir Chamado </a>
            <button onclick="reloadPage() ">Atualizar</button>
        </div>
        <div class="analitics">
            Total chamados abertos: <div id="totalChamadosAbertos"></div>
            Total chamados fechados: <div id="totalChamadosFechados"></div>
            Categoria com mais chamados: <div id="categoriaMaisChamados"></div>
            Mês com maior quantidade de chamados: <div id="mesQuantidadeChamados"></div>
            <div class="chart">
                <canvas id="graficoChamadosAbertosFechados"></canvas>
            </div>

            <div class="chart">
                <canvas id="graficoChamadoPorCategoria"></canvas>
            </div>
            <div class="chart">
                <canvas id="graficoChamadoPorPrioridade"></canvas>
            </div>
            <div class="chart">
                <p>Wordcloud:</p>
                <img style='width:25rem;' src="./assets/wordcloud.png" alt="">
            </div>

        </div>

        <div class="filtragem">
            <div class="filtroDoFiltro">


                <label for="filtro">Filtrar por: </label>
                <select name="" id="filtroSelectOpt" onchange='mostrarCategoriaFiltro()'>
                    <option value="categoria">Categoria</option>
                    <option value="prioridade">Prioridade</option>

                </select>
            </div>
            <div class="novoFiltro">
                <select name="" id="selectFiltroFiltro"
                    onchange='plotarPagina(dadosTodosChamados, selectFiltroFiltro.value)'></select>
            </div>
        </div>
        <div class="content">
            <div id='cardsContent' class="cards-content">
                <div class='cards' id="cards"></div>
            </div>
        </div>
    </div>

</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="./js/chartsVisualizacaoChamados.js"></script>
<script>



    dadosTodosChamados = []
    function listarChamados() {
        //aguardar();

        //aguardar();
        fetch("/listarChamado").then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {
                    console.log(resposta)
                    dadosTodosChamados = resposta
                    demonstrarDados(resposta)
                    plotarPagina(resposta, undefined)

                });
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });



    }

    function demonstrarDados(res) {
        countAbertos = 0

        for (i = 0; i < res.length; i++) {
            if (res[i].isAberto == 1) { // chamados abertos 
                countAbertos++;
            }
        }
        countFechados = res.length - countAbertos
        categoria = getCategoriaRepeticao(res)

        document.getElementById('totalChamadosAbertos').innerHTML = countAbertos;
        document.getElementById('totalChamadosFechados').innerHTML = countFechados;
        document.getElementById('categoriaMaisChamados').innerHTML = categoria

        res = removeChamadosFechados(res)
        plotarGraficoPizzaChamados(countAbertos, countFechados)
        plotarGraficoDataChamados(getDataChamados(res))
        plotarGraficoChamadosPorCategoria(getCategoriasJsonChamadoCount(res))
        plotarGraficoChamadosPorPrioridade(setJsonPrioridades(res))
        console.log(getDataChamados(res))
    }

    function removeChamadosFechados(res) {
        for (i = 0; i < res.length; i++) {
            if (res[i].isAberto == 0) {
                res.splice(i, 1)
            }
            return res
        }
    }
    function setJsonPrioridades(res) {
        prioridades = { 'Normal': 0, 'Alerta': 0, 'Risco': 0 }
        for (i = 0; i < res.length; i++) {

            if (isAberto(res[i].isAberto)) {
                console.log("quebrei ! ")
                break;
            };

            if (res[i].prioridadeChamado == "Normal") prioridades.Normal++;

            if (res[i].prioridadeChamado == "Alerta") prioridades.Alerta++;

            if (res[i].prioridadeCHamado == "Risco") prioridades.Risco++;
        }
        console.log(prioridades)
        return prioridades
    }
    function isAberto(boolean) {

        if (boolean == 1) {
            return false
        }
        return true

    }


    function getCategoriasJsonChamadoCount(res) {

        categoriasCountChamado = [0, 0, 0, 0, 0]

        for (i = 0; i < res.length; i++) {


            categoria = res[i].categoriaChamado

            if (isAberto(res[i].isAberto)) break;

            if (categoria == "Duvidas_e_informacoes") {
                categoriasCountChamado[0]++;
            }
            else if (categoria == "Instabilidade_do_servidor") {
                categoriasCountChamado[1]++;
            }
            else if (categoria == "Incongruencia_nos_dados") {
                categoriasCountChamado[2]++;
            }
            else if (categoria == "Pedido") {
                categoriasCountChamado[3]++;
            }
            else {
                categoriasCountChamado[4]++;
            }
            console.log(res[i])
        }

        return categoriasCountChamado;

    }

    function getDataChamados(arr) {
        datasChamado = []
        for (i = 0; i < arr.length; i++) {
            data = new Date(String(arr[i].dataChamado)).toLocaleDateString()
            console.log(data)

        }
        return datasChamado
    }
    function getCategoriaRepeticao(arr) {
        //add categoria json
        valores = [0, 0, 0, 0, 0]
        categorias = ["Dúvidas e informação",
            "Instabilidade_do_servidor",
            "Incongruencia_dos_dados",
            "Pedido",
            "Outros"]
        max = 0

        for (i = 0; i < arr.length; i++) {
            bool = false;
            for (j = 0; j < categorias.length; j++) {
                if (categorias.indexOf(arr[i].categoriaChamado >= 0)) {

                    bool = true
                }
            }
            if (bool == true) {
                valores[categorias.indexOf(arr[i].categoriaChamado)]++;
            }
        }
        for (i = 0; i < valores.length; i++) {
            if (valores[i] > max) {
                max = valores[i]
            }
        }

        return categorias[valores.indexOf(max)]


    }
    function pltPageHtml(lista, i) {

        if (lista == undefined) {
            document.getElementById(`cards`).innerHTML = ''
            return undefined
        }
        if (lista[i].isAberto == 1) {
            document.getElementById(`cards`).innerHTML +=
                `       
                        <div class='card-chamado'> 
                        <div class="assunto-chamado">${lista[i].assuntoChamado}</div>
                        <div class="categoria-chamado">Categoria: ${tratarCategoria(lista[i].categoriaChamado)}</div>
                        <div class='prioridade-chamado'> Prioridade: ${lista[i].prioridadeChamado} </div> 
                        <hr>
                    
                       
                        <div class="usuario-chamado">${lista[i].nomeUsuario}</div > 
                        <div class="data-chamado">${data}</div>

                        <button onclick='redirectToUrl(${lista[i].idChamado})'>Selecionar</button>
                   </div>
            `
        }

    }

    function plotarPagina(lista, filtro) {
        console.log(lista)
        catFiltro = filtroSelectOpt.value
        for (i = 0; i < lista.length; i++) {
            console.log(lista[i])
            if (catFiltro == 'prioridade')
                if (filtro == lista[i].prioridadeChamado.toLowerCase()) {
                    pltPageHtml(lista, i)
                }
                else {
                    pltPageHtml(undefined, undefined) // zerar page
                }

        }




    }

    function redirectToUrl(id) {
        sessionStorage.IDUSUARIO = id;
        window.location.href = 'chamado.html'
    }
    function reloadPage() {
        document.location.reload();
    }
    function tratarCategoria(text) {
        return text.replaceAll('_', ' ')
    }
    function mostrarCategoriaFiltro() {
        filtro = filtroSelectOpt.value

        if (filtro == 'prioridade') {
            selectFiltroFiltro.innerHTML =
                `<option value="normal">Normal</option>
            <option value="alerta">Alerta</option>
            <option value="risco">Risco</option>`
        }
        else if (filtro == 'categoria') {
            selectFiltroFiltro.innerHTML =
                `<option value="duvidas">Dúvidas e informação</option>
            <option value="instabilidade">Instabilidade do servidor</option>
            <option value="incongruencia">Incongruência</option>
            <option value="pedido">Pedido</option>
            <option value="outros">Outros</option>`
        }

    }
    listarChamados()

</script>