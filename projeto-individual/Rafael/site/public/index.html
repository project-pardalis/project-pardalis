<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="css/style.css">
    <title>Document</title>
</head>

<body>
    <div class="nav">
        <a href="abrirChamados.html">Abrir Chamado </a>
    </div>
    <div class="analitics">
        Total chamados abertos: <div id="totalChamadosAbertos"></div>
        Total chamados fechados: <div id="totalChamadosFechados"></div>
        Categoria com mais chamados: <div id="categoriaMaisChamados"></div>
        Mês com maior quantidade de chamados: <div id="mesQuantidadeChamados"></div>
        <div class="chart">
            <canvas id="graficoChamadosAbertosFechados"></canvas>
        </div>
        <div class="chart">
            <canvas id="graficoChamadosBarraPorData"></canvas>
        </div>

    </div>
    <div class="content">
        <div id='cardsContent' class="cards-content">
            <div class='cards' id="cards"></div>
        </div>
    </div>


</body>

</html>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="./js/chartsVIsualizacaoChamados.js"></script>
<script>
    lista = {}
    function listarChamados() {
        //aguardar();

        //aguardar();
        fetch("/listarChamados").then(function (resposta) {
            if (resposta.ok) {
                resposta.json().then(function (resposta) {

                    demonstrarDados(resposta)
                    plotarPagina(resposta)

                });
            }
        }).catch(function (resposta) {
            console.error(resposta);
        });



    }

    function demonstrarDados(res) {
        countAbertos = 0

        for (i = 0; i < res.length; i++) {
            if (res[i].isAberto == 1) { // chamados abertos 
                countAbertos++;
            }
        }
        countFechados = countAbertos - res.length
        categoria = getCategoriaRepeticao(res)

        document.getElementById('totalChamadosAbertos').innerHTML = countAbertos;
        document.getElementById('totalChamadosFechados').innerHTML = countAbertos - res.length;
        document.getElementById('categoriaMaisChamados').innerHTML = categoria

        plotarGraficoPizzaChamados(countAbertos, countFechados)
        plotarGraficoDataChamados(getDataChamados(res))
        console.log(getDataChamados(res))
    }

    function getDataChamados(arr) {
        datasChamado = []
        for (i = 0; i < arr.length; i++) {
            data = new Date(String(arr[i].dataChamado)).toLocaleDateString()


        }
        return datasChamado
    }
    function getCategoriaRepeticao(arr) {
        //add categoria json
        valores = [0, 0, 0, 0, 0]
        categorias = ["Dúvidas e informação",
            "Instabilidade_do_servidor",
            "Incongruencia_dos_dados",
            "Pedido",
            "Outros"]
        max = 0

        for (i = 0; i < arr.length; i++) {
            bool = false;
            for (j = 0; j < categorias.length; j++) {
                if (categorias.indexOf(arr[i].categoriaChamado >= 0)) {

                    bool = true
                }
            }
            if (bool == true) {
                valores[categorias.indexOf(arr[i].categoriaChamado)]++;
            }
        }
        for (i = 0; i < valores.length; i++) {
            if (valores[i] > max) {
                max = valores[i]
            }
        }

        return categorias[valores.indexOf(max)]


    }

    function plotarPagina(lista) {
        console.log(lista)

        for (i = 0; i < lista.length; i++) {
            data = new Date(String(lista[i].dataChamado)).toLocaleDateString()

            document.getElementById(`cards`).innerHTML +=
                `       
                        <div class='card-chamado'> 
                        <div class="assunto-chamado">${lista[i].assuntoChamado}</div>
                        <div class="categoria-chamado">Categoria: ${lista[i].categoriaChamado}</div>
                        <hr>
                        <div class="descricao-chamado">${lista[i].descricaoChamado}</div>
                       
                        <div class="usuario-chamado">${lista[i].nomeUsuario}</div > 
                        <div class="data-chamado">${data}</div>

                        <button>Selecionar</button>
                   </div>
            `
        }
    }
    listarChamados()

</script>